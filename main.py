# main.py (Flask-SQLAlchemy ORM 統合版 - Render対応)

import os
from datetime import datetime, date, timedelta, time
from flask import Flask, render_template, request, url_for, jsonify, redirect, cli
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import func
from sqlalchemy.exc import IntegrityError, ProgrammingError
import click

# =========================================================================
# データベース設定
# =========================================================================

app = Flask(__name__)

# PostgreSQLの接続設定を優先し、環境変数がない場合はSQLiteにフォールバック
# Flask-SQLAlchemyは、PostgreSQL接続に 'postgresql://' スキームを使用
# Render環境では 'DATABASE_URL' が自動的に設定されます。
DATABASE_URL = os.environ.get('DATABASE_URL', 'sqlite:///school.db')
app.config['SQLALCHEMY_DATABASE_URI'] = DATABASE_URL.replace("postgres://", "postgresql://") # Render互換性のために修正
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

# =========================================================================
# 出席判定に関する定数
# =========================================================================
# 授業開始時刻からこの時間(分)を超えると「欠席」とする (DB改.pyより)
ABSENT_THRESHOLD_MINUTES = 20
# 遅刻判定の閾値（例: 授業開始から10分）
LATE_THRESHOLD_MINUTES = 10

# =========================================================================
# データベーススキーマ定義 (db_setup.pyのSQLをクラスに変換)
# 【注】この部分は長いので省略しますが、あなたのファイルの中身を維持してください。
# =========================================================================

# 1. 曜日マスタ
class 曜日マスタ(db.Model):
    __tablename__ = '曜日マスタ'
    曜日ID = db.Column(db.SmallInteger, primary_key=True) # 0は日曜日
    曜日名 = db.Column(db.String(10), nullable=False)
    備考 = db.Column(db.Text)

# 2. 期マスタ
class 期マスタ(db.Model):
    __tablename__ = '期マスタ'
    期ID = db.Column(db.SmallInteger, primary_key=True)
    期名 = db.Column(db.String(20), nullable=False)
    備考 = db.Column(db.Text)

# 3. 学科
class 学科(db.Model):
    __tablename__ = '学科'
    学科ID = db.Column(db.SmallInteger, primary_key=True)
    学科名 = db.Column(db.String(50))
    備考 = db.Column(db.Text)

# 4. 教室
class 教室(db.Model):
    __tablename__ = '教室'
    教室ID = db.Column(db.SmallInteger, primary_key=True)
    教室名 = db.Column(db.String(50), nullable=False)
    収容人数 = db.Column(db.SmallInteger, nullable=False)
    備考 = db.Column(db.Text)

# 5. 授業科目
class 授業科目(db.Model):
    __tablename__ = '授業科目'
    授業科目ID = db.Column(db.SmallInteger, primary_key=True)
    授業科目名 = db.Column(db.String(100), nullable=False)
    学科ID = db.Column(db.SmallInteger, db.ForeignKey('学科.学科ID'), nullable=False)
    単位 = db.Column(db.SmallInteger, nullable=False)
    開講期 = db.Column(db.String(10), nullable=False) # 例: "1,2"
    備考 = db.Column(db.Text)
    
    学科 = db.relationship('学科', backref=db.backref('授業科目', lazy=True))

# 6. 学生マスタ (ユーザーの新しいスキーマに合わせて変更)
class 学生マスタ(db.Model):
    __tablename__ = '学生マスタ'
    学籍番号 = db.Column(db.Integer, primary_key=True) # 変更: 学生番号 -> 学籍番号
    氏名 = db.Column(db.String(50)) # TEXT NULL
    学年 = db.Column(db.SmallInteger) # 追加: 学年 INTEGER NULL
    学科ID = db.Column(db.SmallInteger, db.ForeignKey('学科.学科ID')) # NULL許容に変更
    期 = db.Column(db.SmallInteger, db.ForeignKey('期マスタ.期ID'), nullable=False) # 追加: 期 TINYINT NOT NULL
    学科 = db.relationship('学科', backref=db.backref('学生', lazy=True))
    期情報 = db.relationship('期マスタ', backref=db.backref('学生', lazy=True))

# 7. 時限設定
class TimeTable(db.Model):
    __tablename__ = 'TimeTable'
    時限 = db.Column(db.SmallInteger, primary_key=True)
    開始時刻 = db.Column(db.Time, nullable=False)
    終了時刻 = db.Column(db.Time, nullable=False)
    備考 = db.Column(db.Text)

# 8. 週時間割
class 週時間割(db.Model):
    __tablename__ = '週時間割'
    年度 = db.Column(db.SmallInteger, primary_key=True)
    学科ID = db.Column(db.SmallInteger, db.ForeignKey('学科.学科ID'), primary_key=True)
    期 = db.Column(db.SmallInteger, db.ForeignKey('期マスタ.期ID'), primary_key=True)
    曜日 = db.Column(db.SmallInteger, db.ForeignKey('曜日マスタ.曜日ID'), primary_key=True)
    時限 = db.Column(db.SmallInteger, db.ForeignKey('TimeTable.時限'), primary_key=True)
    科目ID = db.Column(db.SmallInteger, db.ForeignKey('授業科目.授業科目ID'), nullable=False)
    教室ID = db.Column(db.SmallInteger, db.ForeignKey('教室.教室ID'), nullable=False)
    備考 = db.Column(db.Text)

    科目 = db.relationship('授業科目', backref=db.backref('時間割', lazy=True))
    教室 = db.relationship('教室', backref=db.backref('時間割', lazy=True))
    時間帯 = db.relationship('TimeTable', backref=db.backref('時間割', lazy=True))
    曜日情報 = db.relationship('曜日マスタ', backref=db.backref('時間割', lazy=True))

# 9. 入退室_出席記録 (ログテーブル) - 学生マスタのPK名変更に対応
class 入退室_出席記録(db.Model):
    __tablename__ = '入退室_出席記録'
    記録ID = db.Column(db.Integer, primary_key=True)
    学生番号 = db.Column(db.Integer, db.ForeignKey('学生マスタ.学籍番号'), nullable=False) # 外部キー参照を学籍番号に変更
    入室日時 = db.Column(db.DateTime, nullable=False)
    退室日時 = db.Column(db.DateTime, nullable=True)
    記録日 = db.Column(db.Date, nullable=False) 
    ステータス = db.Column(db.String(10), nullable=False) # '出席', '遅刻', '欠席', '早退', '未定'
    授業科目ID = db.Column(db.SmallInteger, db.ForeignKey('授業科目.授業科目ID'), nullable=True)
    週時間割ID = db.Column(db.String(50), nullable=True) # 便宜的な参照キー (年度-学科ID-期-曜日-時限)
    備考 = db.Column(db.Text)

    学生 = db.relationship('学生マスタ', backref=db.backref('出席記録', lazy=True))
    科目 = db.relationship('授業科目', backref=db.backref('出席記録', lazy=True))

# =========================================================================
# 初期データ挿入関数 (マスタデータ)
# 【注】この部分もあなたのファイルの中身を正確に維持してください。
# =========================================================================

def insert_initial_data():
    """マスタデータと週時間割の全データを挿入する"""
    
    # --- 1. 曜日マスタ ---
    db.session.add_all([
        曜日マスタ(曜日ID=0, 曜日名='授業日'),
        曜日マスタ(曜日ID=1, 曜日名='月曜日'),
        曜日マスタ(曜日ID=2, 曜日名='火曜日'),
        曜日マスタ(曜日ID=3, 曜日名='水曜日'),
        曜日マスタ(曜日ID=4, 曜日名='木曜日'),
        曜日マスタ(曜日ID=5, 曜日名='金曜日'),
        曜日マスタ(曜日ID=6, 曜日名='土曜日'),
        曜日マスタ(曜日ID=7, 曜日名='日曜日'),
        曜日マスタ(曜日ID=8, 曜日名='祝祭日'),
        曜日マスタ(曜日ID=9, 曜日名='休日')
    ])

    # --- 2. 期マスタ ---
    db.session.add_all([
        期マスタ(期ID=1, 期名='Ⅰ'),
        期マスタ(期ID=2, 期名='Ⅱ'),
        期マスタ(期ID=3, 期名='Ⅲ'),
        期マスタ(期ID=4, 期名='Ⅳ'),
        期マスタ(期ID=5, 期名='Ⅴ'),
        期マスタ(期ID=6, 期名='Ⅵ'),
        期マスタ(期ID=7, 期名='Ⅶ'),
        期マスタ(期ID=8, 期名='Ⅷ'),
        期マスタ(期ID=9, 期名='前期(Ⅱ期)集中'),
        期マスタ(期ID=10, 期名='後期(Ⅲ期)集中')
    ])

    # --- 3. 学科 ---
    db.session.add_all([
        学科(学科ID=1, 学科名='生産機械システム技術科', 備考=''),
        学科(学科ID=2, 学科名='生産電気システム技術科', 備考=''),
        学科(学科ID=3, 学科名='生産電子情報システム技術科', 備考='')
    ])

    # --- 4. 教室 ---
    db.session.add_all([
        教室(教室ID=1205, 教室名='A205', 収容人数=20, 備考=''),
        教室(教室ID=2102, 教室名='B102/103', 収容人数=20, 備考=''),
        教室(教室ID=2201, 教室名='B201', 収容人数=20, 備考=''),
        教室(教室ID=2202, 教室名='B202', 収容人数=20, 備考=''),
        教室(教室ID=2204, 教室名='B204', 収容人数=20, 備考=''),
        教室(教室ID=2205, 教室名='B205', 収容人数=20, 備考=''),
        教室(教室ID=2301, 教室名='B301', 収容人数=20, 備考=''),
        教室(教室ID=2302, 教室名='B302', 収容人数=20, 備考=''),
        教室(教室ID=2303, 教室名='B303', 収容人数=20, 備考=''),
        教室(教室ID=2304, 教室名='B304', 収容人数=20, 備考=''),
        教室(教室ID=2305, 教室名='B305', 収容人数=20, 備考=''),
        教室(教室ID=2306, 教室名='B306(視聴覚室)', 収容人数=20, 備考=''),
        教室(教室ID=3101, 教室名='C101(生産ロボット室)', 収容人数=20, 備考=''),
        教室(教室ID=3103, 教室名='C103(開発課題実習室)', 収容人数=20, 備考=''),
        教室(教室ID=3201, 教室名='C201', 収容人数=20, 備考=''),
        教室(教室ID=3202, 教室名='C202(応用課程計測制御応用実習室)', 収容人数=20, 備考=''),
        教室(教室ID=3203, 教室名='C203', 収容人数=20, 備考=''),
        教室(教室ID=3204, 教室名='C204', 収容人数=20, 備考=''),
        教室(教室ID=3231, 教室名='C231(資料室)', 収容人数=20, 備考=''),
        教室(教室ID=3301, 教室名='C301(マルチメディア実習室)', 収容人数=20, 備考=''),
        教室(教室ID=3302, 教室名='C302(システム開発実習室)', 収容人数=20, 備考=''),
        教室(教室ID=3303, 教室名='C303(システム開発実習室Ⅱ)', 収容人数=20, 備考=''),
        教室(教室ID=3304, 教室名='C304/305(応用課程生産管理ネットワーク応用実習室)', 収容人数=20, 備考=''),
        教室(教室ID=3306, 教室名='C306(共通実習室)', 収容人数=20, 備考=''),
        教室(教室ID=4102, 教室名='D102(回路基板加工室)', 収容人数=20, 備考=''),
        教室(教室ID=4201, 教室名='D201(開発課題実習室)', 収容人数=20, 備考=''),
        教室(教室ID=4202, 教室名='D202(電子情報技術科教官室)', 収容人数=20, 備考=''),
        教室(教室ID=4231, 教室名='D231(準備室)', 収容人数=20, 備考=''),
        教室(教室ID=4301, 教室名='D301', 収容人数=20, 備考=''),
        教室(教室ID=4302, 教室名='D302(PC実習室)', 収容人数=20, 備考='')
    ])

    # --- 5. 授業科目 ---
    db.session.add_all([
        授業科目(授業科目ID=301, 授業科目名='工業技術英語', 学科ID=3, 単位=2, 開講期='3,4'),
        授業科目(授業科目ID=302, 授業科目名='生産管理', 学科ID=3, 単位=2, 開講期='3'),
        授業科目(授業科目ID=303, 授業科目名='品質管理', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=304, 授業科目名='経営管理', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=305, 授業科目名='創造的開発技法', 学科ID=3, 単位=2, 開講期='3'),
        授業科目(授業科目ID=306, 授業科目名='工業法規', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=307, 授業科目名='職業能力開発体系論', 学科ID=3, 単位=2, 開講期='3'),

        授業科目(授業科目ID=308, 授業科目名='機械工学概論', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=309, 授業科目名='アナログ回路応用設計技術', 学科ID=3, 単位=2, 開講期='3'),
        授業科目(授業科目ID=310, 授業科目名='ディジタル回路応用設計技術', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=311, 授業科目名='複合電子回路応用設計技術', 学科ID=3, 単位=2, 開講期='3,4'),

        授業科目(授業科目ID=312, 授業科目名='ロボット工学', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=313, 授業科目名='通信プロトコル実装設計', 学科ID=3, 単位=2, 開講期='3'),
        授業科目(授業科目ID=314, 授業科目名='セキュアシステム設計', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=315, 授業科目名='組込みシステム設計', 学科ID=3, 単位=4, 開講期='3,4'),

        授業科目(授業科目ID=316, 授業科目名='安全衛生管理', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=317, 授業科目名='機械工作・組立実習', 学科ID=3, 単位=4, 開講期='3'),
        授業科目(授業科目ID=318, 授業科目名='実装設計製作実習', 学科ID=3, 単位=4, 開講期='4'),
        授業科目(授業科目ID=319, 授業科目名='EMC応用実習', 学科ID=3, 単位=4, 開講期='3,4'),

        授業科目(授業科目ID=320, 授業科目名='電子回路設計製作応用実習', 学科ID=3, 単位=4, 開講期='4'),
        授業科目(授業科目ID=321, 授業科目名='制御回路設計製作実習', 学科ID=3, 単位=4, 開講期='3'),
        授業科目(授業科目ID=322, 授業科目名='センシングシステム構築実習', 学科ID=3, 単位=4, 開講期='4'),
        授業科目(授業科目ID=323, 授業科目名='ロボット工学実習', 学科ID=3, 単位=2, 開講期='3,4'),

        授業科目(授業科目ID=324, 授業科目名='通信プロトコル実装実習', 学科ID=3, 単位=4, 開講期='4'),
        授業科目(授業科目ID=325, 授業科目名='セキュアシステム構築実習', 学科ID=3, 単位=4, 開講期='3'),
        授業科目(授業科目ID=326, 授業科目名='生産管理システム構築実習Ⅰ', 学科ID=3, 単位=2, 開講期='4'),
        授業科目(授業科目ID=327, 授業科目名='生産管理システム構築実習Ⅱ', 学科ID=3, 単位=2, 開講期='3,4'),

        授業科目(授業科目ID=328, 授業科目名='組込システム構築実習', 学科ID=3, 単位=4, 開講期='4'),
        授業科目(授業科目ID=329, 授業科目名='組込デバイス設計実習', 学科ID=3, 単位=4, 開講期='3'),
        授業科目(授業科目ID=330, 授業科目名='組込システム構築課題実習', 学科ID=3, 単位=10, 開講期='4'),
        授業科目(授業科目ID=331, 授業科目名='電子通信機器設計製作課題実習', 学科ID=3, 単位=10, 開講期='3,4'),

        授業科目(授業科目ID=332, 授業科目名='ロボット機器製作課題実習(電子情報)', 学科ID=3, 単位=10, 開講期='4'),
        授業科目(授業科目ID=333, 授業科目名='ロボット機器運用課題実習(電子情報)', 学科ID=3, 単位=10, 開講期='3'),
        授業科目(授業科目ID=380, 授業科目名='標準課題Ⅰ', 学科ID=3, 単位=10, 開講期='4'),
        授業科目(授業科目ID=381, 授業科目名='標準課題Ⅱ', 学科ID=3, 単位=10, 開講期='3,4'),

        授業科目(授業科目ID=334, 授業科目名='電子装置設計製作応用課題実習', 学科ID=3, 単位=54, 開講期='4'),
        授業科目(授業科目ID=335, 授業科目名='組込システム応用課題実習', 学科ID=3, 単位=54, 開講期='3'),
        授業科目(授業科目ID=336, 授業科目名='通信システム応用課題実習', 学科ID=3, 単位=54, 開講期='4'),
        授業科目(授業科目ID=337, 授業科目名='ロボットシステム応用課題実習', 学科ID=3, 単位=54, 開講期='3,4'),
        授業科目(授業科目ID=390, 授業科目名='開発課題', 学科ID=3, 単位=54, 開講期='3,4'),

    ])

    # --- 6. 学生マスタ (電子情報系 30名) - 新しいスキーマに対応 ---
    STUDENT_GRADE = 3 # 学年
    STUDENT_TERM = 4 # 期 (4期を仮定)
    
    # 新しいデータ構造: (学籍番号, 氏名, 学科ID, 学年, 期)
    students_data = [
        (222521301,'青井 渓一郎',3,1,3),(222521302,'赤坂 龍成',3,1,3),(222521303,'秋好 拓海',3,1,3),(222521304,'伊川 翔',3,1,3),
        (222521305,'岩切 亮太',3,1,3),(222521306,'上田 和輝',3,1,3),(222521307,'江本 龍之介',3,1,3),(222521308,'大久保 碧瀧',3,1,3),
        (222521309,'加來 涼雅',3,1,3),(222521310,'梶原 悠平',3,1,3),(222521311,'管野 友富紀',3,1,3),(222521312,'髙口 翔真',3,1,3),
        (222521313,'古城 静雅',3,1,3),(222521314,'小柳 知也',3,1,3),(222521315,'酒元 翼',3,1,3),(222521316,'座光寺 孝彦',3,1,3),
        (222521317,'佐野 勇太',3,1,3),(222521318,'清水 健心',3,1,3),(222521319,'新谷 雄飛',3,1,3),(222521320,'関原 響樹',3,1,3),
        (222521321,'髙橋 優人',3,1,3),(222521322,'武富 義樹',3,1,3),(222521323,'内藤 俊介',3,1,3),(222521324,'野田 千尋',3,1,3),
        (222521325,'野中 雄学',3,1,3),(222521326,'東 奈月',3,1,3),(222521327,'古田 雅也',3,1,3),(222521328,'牧野 倭大',3,1,3),
        (222521330,'宮岡 嘉熙',3,1,3),(222521329,'松隈 駿介',3,1,3)
    ]
    
    db.session.add_all([
        学生マスタ(学籍番号=s[0], 氏名=s[1], 学科ID=s[2], 学年=s[3], 期=s[4]) for s in students_data
    ])

    # --- 7. 時限設定 ---
    db.session.add_all([
        TimeTable(時限=1, 開始時刻=time(8, 50), 終了時刻=time(10, 30), 備考='1限目'),
        TimeTable(時限=2, 開始時刻=time(10, 35), 終了時刻=time(12, 15), 備考='2限目'),
        TimeTable(時限=3, 開始時刻=time(13, 0), 終了時刻=time(14, 40), 備考='3限目'),
        TimeTable(時限=4, 開始時刻=time(14, 45), 終了時刻=time(16, 25), 備考='4限目'),
        TimeTable(時限=5, 開始時刻=time(16, 40), 終了時刻=time(18, 20), 備考='5限目')
    ])
    
    # --- 8. 週時間割 (2025年度 電子情報系 302) ---
    # 月曜から金曜の1〜5時限を網羅
    timetable_data = [
        # 2025年度 3期 (電子情報系: 302)
        # 月曜日 (曜日ID=1)
        (2025, 3, 3, 1, 1, 327, 3301, '/中山'),
        (2025, 3, 3, 1, 2, 327, 3301, '/中山'),
        (2025, 3, 3, 1, 3, 380, 3301, 'C302/電子情報系'),
        (2025, 3, 3, 1, 4, 380, 3301, 'C302/電子情報系'),
        # 火曜日 (曜日ID=2)
        (2025, 3, 3, 2, 1, 317, 3302, 'K302/機械系'),
        (2025, 3, 3, 2, 2, 317, 3302, 'K302/機械系'),
        (2025, 3, 3, 2, 3, 380, 3301, 'C302/電子情報系'),
        (2025, 3, 3, 2, 4, 380, 3301, 'C302/電子情報系'),
        # 水曜日 (曜日ID=3)
        (2025, 3, 3, 3, 1, 329, 3301, '/岡田'),
        (2025, 3, 3, 3, 2, 329, 3301, '/岡田'),
        (2025, 3, 3, 3, 3, 308, 2301, '/上野'),
        # 木曜日 (曜日ID=4)
        (2025, 3, 3, 4, 1, 380, 3301, 'C302/電子情報系'),
        (2025, 3, 3, 4, 2, 380, 3301, 'C302/電子情報系'),
        (2025, 3, 3, 4, 3, 380, 3301, 'C302/電子情報系'),
        (2025, 3, 3, 4, 4, 380, 3301, 'C302/電子情報系'),
        # 金曜日 (曜日ID=5)
        (2025, 3, 3, 5, 1, 321, 3302, '/玉井'),
        (2025, 3, 3, 5, 2, 321, 3302, '/玉井'),
        (2025, 3, 3, 5, 3, 380, 3301, 'C302/電子情報系'),
        (2025, 3, 3, 5, 4, 380, 3301, 'C302/電子情報系'),

        # 2025年度 4期 (電子情報系: 302)
        # 月曜日 (曜日ID=1)
        (2025, 3, 4, 1, 1, 381, 3302, 'C101/電子情報系'),
        (2025, 3, 4, 1, 2, 381, 3302, 'C101/電子情報系'),
        # 火曜日 (曜日ID=2)
        (2025, 3, 4, 2, 1, 317, 3302, 'K302/機械系'),
        (2025, 3, 4, 2, 2, 317, 3302, 'K302/機械系'),
        (2025, 3, 4, 2, 3, 381, 3302, 'C101/電子情報系'),
        (2025, 3, 4, 2, 4, 381, 3302, 'C101/電子情報系'),
        # 水曜日 (曜日ID=3)
        (2025, 3, 4, 3, 1, 329, 3301, '/岡田'),
        (2025, 3, 4, 3, 2, 329, 3301, '/岡田'),
        (2025, 3, 4, 3, 3, 308, 2301, '/上野'),
        # 木曜日 (曜日ID=4)
        (2025, 3, 4, 4, 1, 331, 3302, 'C101/電子情報系'),
        (2025, 3, 4, 4, 2, 331, 3302, 'C101/電子情報系'),
        (2025, 3, 4, 4, 3, 331, 3302, 'C101/電子情報系'),
        (2025, 3, 4, 4, 4, 331, 3302, 'C101/電子情報系'),
        # 金曜日 (曜日ID=5)
        (2025, 3, 4, 5, 1, 331, 3302, 'C101/電子情報系'),
        (2025, 3, 4, 5, 2, 331, 3302, 'C101/電子情報系')
    ]

    db.session.add_all([
        週時間割(年度=t[0], 学科ID=t[1], 期=t[2], 曜日=t[3], 時限=t[4], 科目ID=t[5], 教室ID=t[6], 備考=t[7]) for t in timetable_data
    ])

    db.session.commit()

# =========================================================================
# データベース初期化ロジック (CLIコマンドを置き換え)
# =========================================================================

def init_db_on_startup():
    """
    アプリケーション起動時にデータベースの初期化を試行します。
    テーブルが存在しない場合（初回デプロイ時）のみ作成します。
    """
    with app.app_context():
        try:
            # PostgreSQLでテーブルが存在するかを高速にチェック
            # '学生マスタ'がPostgreSQLに存在するかを確認
            if db.engine.dialect.has_table(db.engine.connect(), '学生マスタ'):
                print("データベースのテーブルは既に存在します。初期化をスキップします。")
                # 既存データがないことを確認したい場合は、ここで _insert_initial_data() を呼ぶ
            else:
                print("データベースのテーブルが存在しません。テーブル作成と初期データ挿入を開始します。")
                db.create_all() # すべてのテーブルを作成
                print("テーブル作成が完了しました。")
                _insert_initial_data() # マスタデータを挿入

        except ProgrammingError as e:
            # テーブルチェック中にエラーが発生した場合 (例: データベース自体がまだ準備中)
            print(f"警告: テーブルチェック中にエラーが発生しました ({e.orig.pgcode})。強制的にテーブル作成を試みます。")
            db.create_all()
            _insert_initial_data()
        except Exception as e:
            print(f"致命的なデータベース初期化エラー: {e}")

# =========================================================================
# ルーティング（省略）
# 【注】この部分もあなたのファイルの中身を維持してください。
# =========================================================================

@app.route('/')
def index_page():
    current_class_id = 3
    current_class_name = "電子情報系3年"

    try:
        # ✅ 修正: 期マスタとの結合と、期マスタ.期名の選択を削除
        students_with_info = db.session.query(
            学生マスタ.学籍番号,
            学生マスタ.氏名,
            学科.学科名,
            # 期マスタ.期名 は削除
        ).join(学科, 学生マスタ.学科ID == 学科.学科ID) \
         .filter(学生マスタ.学科ID == current_class_id) \
         .order_by(学生マスタ.学籍番号).all()

        # テンプレートに正しいデータを渡す
        return render_template('index.html', 
                               students=students_with_info, 
                               current_class=current_class_name, 
                               current_class_id=current_class_id)
        
    except Exception as e:
        # データベース接続やその他のエラーが発生した場合
        return f"データベースクエリ実行中にエラーが発生しました: {e}", 500


# =========================================================================
# データベースの初期化とWebアプリの実行
# =========================================================================

# アプリケーションコンテキスト内でデータベース初期化を実行する関数
def initialize_database_on_startup():
    """
    アプリケーションコンテキスト内でテーブル作成とマスタデータ挿入を自動で実行する。
    Gunicorn/Render環境で、アプリ起動時にデータベースを初期化する。
    """
    with app.app_context():
        print("データベース接続を確認し、テーブルをリセットして再作成します...")
        try:
            # 【重要】古いデータを完全に消し、最新のマスタデータを挿入するために実行
            # db.drop_all() のコメントアウトを外し、テーブルを強制削除
            db.drop_all() 

            db.create_all()
            _insert_initial_data() 
            print("✅ データベースの初期化とマスタデータの上書きが完了しました。")
            
        except Exception as e:
            # ログ出力のみ行い、アプリの起動を妨げない
            print(f"⚠️ データベース初期化中にエラーが発生しましたが、無視して起動を続けます: {e}")
            
# 💡 Render環境では、Gunicornがアプリをロードする際に初期化処理が実行されます。
init_db_on_startup()


if __name__ == "__main__":
    # ローカル実行用: initialize_database_on_startup() を直接呼び出す
    print("\n-------------------------------------------")
    print("ローカル開発環境でデータベースを初期化し、Webアプリを起動します。")
    initialize_database_on_startup() # ローカル起動時に初期化を実行
    app.run(debug=True, host='0.0.0.0', port=5000)
else:
    # Gunicorn/Renderで起動した場合: 初期化関数のみを呼び出す
    # GunicornがWebサーバーとしての役割を果たすため、app.run() は不要
    print("Render/Gunicorn環境でデータベースの初期化を実行します。")
    initialize_database_on_startup() 
    # **注意: ここに app.run() は書かないでください。**





