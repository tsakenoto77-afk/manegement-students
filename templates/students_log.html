{% extends "base.html" %}

{% block content %}

{# ページのタイトルと学生情報 #}
{% if data.student_info %}
    <h2 class="section-title">
        <i class="fas fa-user-circle me-2"></i>学生ログ: {{ data.student_info['氏名'] }}
        <span class="badge bg-secondary ms-2">{{ data.student_info['学科名'] }}</span>
    </h2>
    <p class="text-muted">学籍番号: **{{ data.student_id }}** の最新の入退室・出席記録 (最大50件) を表示しています。</p>
{% else %}
    <h2 class="section-title"><i class="fas fa-user-circle me-2"></i>学生ログ: 不明な学生 ({{ data.student_id }})</h2>
    <div class="alert alert-warning" role="alert">該当する学生情報が見つかりませんでした。</div>
{% endif %}

<hr>

{# ========================================================================= #}
{# ?? 期別出席率の表示 #}
{# ========================================================================= #}
<div class="card p-4 mb-4">
    <h5 class="card-title text-primary"><i class="fas fa-percent me-2"></i>期別 出席率</h5>
    <div class="row row-cols-2 row-cols-md-4 g-3 mt-2">
        
        {# 期が1から4まで固定で表示されるようにループ (data.attendance_statsにデータがない期は 0/0 になる) #}
        {% for i in range(1, 5) %}
        {% set term_name = i ~ '期' %}
        {% set stats = data.attendance_stats.get(term_name, {'attended': 0, 'total': 0, 'rate': '0.0%'}) %}
        <div class="col">
            <div class="card text-center bg-light h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">{{ term_name }}</h6>
                    
                    {# 出席率のパーセンテージを取得し、表示色を決定 #}
                    {% set rate_float = stats.rate|replace('%', '')|float %}
                    <h3 class="card-text fw-bold 
                        {% if stats.total == 0 %}text-secondary{% elif rate_float >= 80 %}text-success{% elif rate_float >= 50 %}text-warning{% else %}text-danger{% endif %}
                        ">
                        {{ stats.rate }}
                    </h3>
                    <p class="card-text"><small class="text-muted">{{ stats.attended }}/{{ stats.total }} レッスン出席</small></p>
                </div>
            </div>
        </div>
        {% endfor %}
        
    </div>
    
    {% if not data.attendance_stats or data.attendance_stats.values()|map(attribute='total')|sum == 0 %}
    <div class="alert alert-info py-2 mt-3" role="alert">出席率データがありません（週時間割設定または入室記録がない）。</div>
    {% endif %}
</div>
{# ========================================================================= #}


<div class="card p-3 table-responsive-custom mt-4">
{% if data.logs %}
<h5 class="card-title text-primary mb-3"><i class="fas fa-list-alt me-2"></i>入退出記録 (最新50件)</h5>
<table class="table table-striped table-hover data-table mb-0">
    <thead class="table-dark">
    <tr>
        <th>ID</th><th>日時</th><th>区分</th><th>出席状況</th><th>教室</th><th>備考</th><th>操作</th>
    </tr>
    </thead>
    <tbody>
    {% for r in data.logs %}
    <tr>
        <td>{{ r['記録ID'] }}</td>
        <td>{{ r['入退出時間'] }}</td>
        <td>
        {% if r['区分'] == '入室' %}
            <span class="badge bg-success"><i class="fas fa-sign-in-alt"></i> 入室</span>
        {% elif r['区分'] == '退室' %}
            <span class="badge bg-info text-dark"><i class="fas fa-sign-out-alt"></i> 退室</span>
        {% else %}
            <span class="badge bg-secondary">--</span>
        {% endif %}
        </td>
        <td>
        {% if r['出席'] == '出席' %}
            <span class="badge bg-primary"><i class="fas fa-check"></i> 出席</span>
        {% elif r['出席'] == '欠席' and r['区分'] == '入室' %}
            <span class="badge bg-warning text-dark" title="開始時刻から{{ data.LATE_TIME_MINUTES }}分以上遅れて入室">
                <i class="fas fa-user-clock"></i> 欠席(遅刻)
            </span>
        {% elif r['出席'] == '欠席' and r['区分'] == '退室' %}
            {# DB改.pyのロジックでは退室時に「欠席(早退)」は記録されないが、テンプレートの互換性のため残す #}
            <span class="badge bg-info text-dark" title="終了時刻より早く退室">
                <i class="fas fa-running"></i> 欠席(早退)
            </span>
        {% elif r['出席'] == '欠席' %}
            <span class="badge bg-danger"><i class="fas fa-times"></i> 欠席</span>
        {% else %}
            <span class="badge bg-secondary">--</span>
        {% endif %}
        </td>
        <td>{{ r['教室名'] if r['教室名'] else '不明な教室' }}</td>
        <td style="max-width: 300px; white-space: normal;">
            <small>{{ r['備考'] | default('---') }}</small>
        </td>
        <td>
            <form method="POST" action="{{ url_for('delete_record', record_id=r['記録ID']) }}" style="display:inline;" onsubmit="return confirm('本当に記録ID:{{ r['記録ID'] }}の記録を削除しますか？');">
                <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="fas fa-trash-alt"></i></button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<div class="alert alert-info" role="alert">この学生の入退室記録はまだありません。</div>
{% endif %}
</div>

{% endblock %}
